<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版HID鼠标参数配置工具</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        danger: '#F87272',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .device-card {
                @apply bg-white rounded-xl shadow-md p-5 transition-all duration-300 hover:shadow-lg;
            }
            .control-group {
                @apply mb-6;
            }
            .control-label {
                @apply block text-sm font-medium text-gray-700 mb-2;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .btn-outline {
                @apply border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-all duration-200;
            }
            .btn-danger {
                @apply bg-danger text-white px-4 py-2 rounded-lg hover:bg-danger/90 transition-all duration-200;
            }
            .status-indicator {
                @apply w-3 h-3 rounded-full inline-block mr-2;
            }
            .macro-step {
                @apply p-3 bg-gray-50 rounded border border-gray-200 mb-2 text-sm;
            }
            .rate-button {
                @apply px-3 py-1 border rounded-md hover:bg-gray-50 transition-colors;
            }
            .rate-button.active {
                @apply bg-primary text-white border-primary;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-10">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-2 flex items-center">
                <i class="fa fa-mouse-pointer text-primary mr-3"></i>增强版HID鼠标参数配置工具
            </h1>
            <p class="text-gray-600 max-w-2xl">高级鼠标参数配置，支持回报率、CPI设置和宏录制功能</p>
        </header>
        
        <!-- 设备连接区域 -->
        <div class="device-card mb-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold mb-1">设备连接</h2>
                    <p class="text-gray-500 text-sm">连接并授权访问你的HID鼠标设备</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button id="connect-btn" class="btn-primary flex items-center">
                        <i class="fa fa-plug mr-2"></i>连接鼠标设备
                    </button>
                </div>
            </div>
            
            <div id="device-status" class="mt-4 flex items-center text-gray-500">
                <span class="status-indicator bg-gray-300"></span>
                <span>未连接设备</span>
            </div>
            
            <div id="device-info" class="mt-4 hidden">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <h3 class="font-medium mb-2">设备信息</h3>
                    <table class="text-sm w-full">
                        <tbody>
                            <tr class="border-b border-gray-100">
                                <td class="py-2 text-gray-500">厂商:</td>
                                <td id="manufacturer" class="py-2 font-medium">未知</td>
                            </tr>
                            <tr class="border-b border-gray-100">
                                <td class="py-2 text-gray-500">产品:</td>
                                <td id="product" class="py-2 font-medium">未知</td>
                            </tr>
                            <tr class="border-b border-gray-100">
                                <td class="py-2 text-gray-500">产品ID:</td>
                                <td id="product-id" class="py-2 font-mono">0000</td>
                            </tr>
                            <tr>
                                <td class="py-2 text-gray-500">厂商ID:</td>
                                <td id="vendor-id" class="py-2 font-mono">0000</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 参数配置区域 -->
        <div id="configuration-panel" class="device-card hidden">
            <h2 class="text-xl font-semibold mb-6">鼠标参数配置</h2>
            
            <!-- 标签页导航 -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button class="config-tab active py-4 px-1 border-b-2 border-primary text-primary font-medium" data-tab="basic">基本设置</button>
                    <button class="config-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="advanced">高级设置</button>
                    <button class="config-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="macros">宏设置</button>
                </nav>
            </div>
            
            <!-- 基本设置标签页 -->
            <div class="tab-content" id="basic-tab">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- CPI设置 (替代DPI) -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-dashboard text-primary mr-1"></i>鼠标CPI ( Counts Per Inch )
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="cpi-slider" min="400" max="16000" step="100" value="1600" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="cpi-value" class="ml-4 min-w-[80px] text-center font-medium">1600 CPI</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>400</span>
                            <span>16000</span>
                        </div>
                        <button id="set-cpi" class="mt-3 btn-primary text-sm py-1">应用CPI设置</button>
                    </div>
                    
                    <!-- 按键映射 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-exchange text-primary mr-1"></i>按键映射
                        </label>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="swap-buttons" class="accent-primary">
                                <label for="swap-buttons" class="ml-2">互换左右鼠标键</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="invert-scroll" class="accent-primary">
                                <label for="invert-scroll" class="ml-2">反转滚轮方向</label>
                            </div>
                        </div>
                        <button id="set-buttons" class="mt-3 btn-primary text-sm py-1">应用按键设置</button>
                    </div>
                    
                    <!-- 双击速度 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-clock-o text-primary mr-1"></i>双击速度
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="double-click-speed" min="100" max="1000" step="50" value="500"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="double-click-value" class="ml-4 min-w-[80px] text-center font-medium">500 ms</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>快</span>
                            <span>慢</span>
                        </div>
                        <button id="set-double-click" class="mt-3 btn-primary text-sm py-1">应用双击设置</button>
                    </div>
                    
                    <!-- 滚轮速度 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-arrows-v text-primary mr-1"></i>滚轮速度
                        </label>
                        <div class="flex items-center">
                            <input type="range" id="scroll-speed" min="1" max="10" step="1" value="3"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="scroll-value" class="ml-4 min-w-[80px] text-center font-medium">3</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>慢</span>
                            <span>快</span>
                        </div>
                        <button id="set-scroll" class="mt-3 btn-primary text-sm py-1">应用滚轮设置</button>
                    </div>
                </div>
            </div>
            
            <!-- 高级设置标签页 -->
            <div class="tab-content hidden" id="advanced-tab">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 回报率设置 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-refresh text-primary mr-1"></i>回报率 (Polling Rate)
                        </label>
                        <p class="text-xs text-gray-500 mb-3">设置鼠标向电脑发送数据的频率，越高响应越快</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button class="rate-button" data-rate="125">125 Hz</button>
                            <button class="rate-button" data-rate="250">250 Hz</button>
                            <button class="rate-button" data-rate="500">500 Hz</button>
                            <button class="rate-button" data-rate="1000">1000 Hz</button>
                        </div>
                        <input type="hidden" id="selected-rate" value="1000">
                        <button id="set-rate" class="btn-primary text-sm py-1">应用回报率设置</button>
                    </div>
                    
                    <!-- 高级传感器设置 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-microchip text-primary mr-1"></i>传感器设置
                        </label>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="angle-snapping" class="accent-primary">
                                <label for="angle-snapping" class="ml-2">启用角度捕捉</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="acceleration" class="accent-primary">
                                <label for="acceleration" class="ml-2">启用鼠标加速</label>
                            </div>
                        </div>
                        <button id="set-sensor" class="mt-3 btn-primary text-sm py-1">应用传感器设置</button>
                    </div>
                    
                    <!-- 灯光设置 -->
                    <div class="control-group">
                        <label class="control-label">
                            <i class="fa fa-lightbulb-o text-primary mr-1"></i>灯光设置
                        </label>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">灯光模式</label>
                                <select id="light-mode" class="w-full border rounded-md p-2">
                                    <option value="off">关闭</option>
                                    <option value="static">静态</option>
                                    <option value="breathing">呼吸</option>
                                    <option value="rainbow">彩虹</option>
                                    <option value="reactive">反应式</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">亮度</label>
                                <input type="range" id="light-brightness" min="0" max="100" step="10" value="70"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            </div>
                        </div>
                        <button id="set-light" class="mt-3 btn-primary text-sm py-1">应用灯光设置</button>
                    </div>
                </div>
            </div>
            
            <!-- 宏设置标签页 -->
            <div class="tab-content hidden" id="macros-tab">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 宏列表 -->
                    <div class="lg:col-span-1">
                        <label class="control-label">宏列表</label>
                        <div class="border rounded-lg p-2 mb-3 max-h-60 overflow-y-auto">
                            <div class="macro-item p-2 mb-1 rounded hover:bg-gray-50 cursor-pointer" data-macro="1">宏 1</div>
                            <div class="macro-item p-2 mb-1 rounded hover:bg-gray-50 cursor-pointer" data-macro="2">宏 2</div>
                            <div class="macro-item p-2 mb-1 rounded hover:bg-gray-50 cursor-pointer" data-macro="3">宏 3</div>
                            <div class="macro-item p-2 mb-1 rounded hover:bg-gray-50 cursor-pointer" data-macro="4">宏 4</div>
                        </div>
                        <div class="flex gap-2">
                            <button id="new-macro" class="btn-primary text-sm py-1 flex-1">新建宏</button>
                            <button id="delete-macro" class="btn-danger text-sm py-1">删除</button>
                        </div>
                        
                        <div class="mt-6">
                            <label class="control-label">宏绑定按键</label>
                            <select id="macro-button" class="w-full border rounded-md p-2">
                                <option value="none">未绑定</option>
                                <option value="button4">侧键 1</option>
                                <option value="button5">侧键 2</option>
                                <option value="doubleclick">双击</option>
                                <option value="scrollup">滚轮上</option>
                                <option value="scrolldown">滚轮下</option>
                            </select>
                            <button id="bind-macro" class="mt-3 btn-primary text-sm py-1 w-full">绑定到按键</button>
                        </div>
                    </div>
                    
                    <!-- 宏录制区域 -->
                    <div class="lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <label class="control-label">宏编辑</label>
                            <div class="flex gap-2">
                                <button id="start-record" class="btn-primary text-sm py-1">
                                    <i class="fa fa-circle mr-1"></i>开始录制
                                </button>
                                <button id="stop-record" class="btn-danger text-sm py-1 hidden">
                                    <i class="fa fa-square mr-1"></i>停止录制
                                </button>
                                <button id="play-macro" class="btn-outline text-sm py-1">
                                    <i class="fa fa-play mr-1"></i>播放
                                </button>
                            </div>
                        </div>
                        
                        <div id="recording-indicator" class="bg-amber-50 text-amber-800 p-3 rounded-lg mb-4 hidden">
                            <i class="fa fa-circle-o-notch fa-spin mr-2"></i>正在录制宏... 移动鼠标、点击或按键
                        </div>
                        
                        <div class="border rounded-lg p-3 h-60 overflow-y-auto bg-gray-50" id="macro-steps">
                            <div class="text-gray-500 text-center py-10">
                                宏命令将显示在这里<br>点击"开始录制"创建宏
                            </div>
                        </div>
                        
                        <div class="mt-4 flex justify-end">
                            <button id="save-macro" class="btn-primary text-sm py-1">保存宏设置</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 状态消息区域 -->
            <div id="message-area" class="mt-6 p-4 rounded-lg hidden"></div>
        </div>
        
        <!-- 不支持提示 -->
        <div id="unsupported-warning" class="device-card bg-amber-50 border border-amber-100 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-triangle text-amber-500 text-xl mt-0.5"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-amber-800">浏览器不支持WebHID API</h3>
                    <div class="mt-2 text-sm text-amber-700">
                        <p>请使用最新版本的Chrome、Edge或Opera浏览器以使用此功能。WebHID API目前不被Safari支持。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 检查浏览器是否支持WebHID API
        if (!('hid' in navigator)) {
            document.getElementById('unsupported-warning').classList.remove('hidden');
        } else {
            // 全局变量
            let device = null;
            let isRecording = false;
            let currentMacro = [];
            let selectedMacroId = 1;
            const HID_MOUSE_USAGE_PAGE = 0x01; // 通用桌面控制页
            const HID_MOUSE_USAGE = 0x02;     // 鼠标设备
            
            // DOM元素
            const connectBtn = document.getElementById('connect-btn');
            const deviceStatus = document.getElementById('device-status');
            const deviceInfo = document.getElementById('device-info');
            const configurationPanel = document.getElementById('configuration-panel');
            const messageArea = document.getElementById('message-area');
            
            // 设备信息元素
            const manufacturerEl = document.getElementById('manufacturer');
            const productEl = document.getElementById('product');
            const productIdEl = document.getElementById('product-id');
            const vendorIdEl = document.getElementById('vendor-id');
            
            // 参数控制元素
            const cpiSlider = document.getElementById('cpi-slider');
            const cpiValue = document.getElementById('cpi-value');
            const swapButtons = document.getElementById('swap-buttons');
            const invertScroll = document.getElementById('invert-scroll');
            const doubleClickSpeed = document.getElementById('double-click-speed');
            const doubleClickValue = document.getElementById('double-click-value');
            const scrollSpeed = document.getElementById('scroll-speed');
            const scrollValue = document.getElementById('scroll-value');
            
            // 高级设置元素
            const rateButtons = document.querySelectorAll('.rate-button');
            const selectedRate = document.getElementById('selected-rate');
            const angleSnapping = document.getElementById('angle-snapping');
            const acceleration = document.getElementById('acceleration');
            const lightMode = document.getElementById('light-mode');
            const lightBrightness = document.getElementById('light-brightness');
            
            // 宏设置元素
            const macroItems = document.querySelectorAll('.macro-item');
            const newMacroBtn = document.getElementById('new-macro');
            const deleteMacroBtn = document.getElementById('delete-macro');
            const macroButton = document.getElementById('macro-button');
            const bindMacroBtn = document.getElementById('bind-macro');
            const startRecordBtn = document.getElementById('start-record');
            const stopRecordBtn = document.getElementById('stop-record');
            const playMacroBtn = document.getElementById('play-macro');
            const recordingIndicator = document.getElementById('recording-indicator');
            const macroSteps = document.getElementById('macro-steps');
            const saveMacroBtn = document.getElementById('save-macro');
            
            // 标签页控制
            const configTabs = document.querySelectorAll('.config-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // 更新显示值
            cpiSlider.addEventListener('input', () => {
                cpiValue.textContent = `${cpiSlider.value} CPI`;
            });
            
            doubleClickSpeed.addEventListener('input', () => {
                doubleClickValue.textContent = `${doubleClickSpeed.value} ms`;
            });
            
            scrollSpeed.addEventListener('input', () => {
                scrollValue.textContent = scrollSpeed.value;
            });
            
            // 回报率按钮选择
            rateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    rateButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedRate.value = button.dataset.rate;
                });
            });
            
            // 默认选中1000Hz
            rateButtons.forEach(btn => {
                if (btn.dataset.rate === '1000') {
                    btn.classList.add('active');
                }
            });
            
            // 标签页切换
            configTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有活动状态
                    configTabs.forEach(t => {
                        t.classList.remove('active', 'border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // 添加当前活动状态
                    tab.classList.add('active', 'border-primary', 'text-primary');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                    
                    // 隐藏所有内容
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // 显示当前内容
                    const tabId = tab.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                });
            });
            
            // 宏选择
            macroItems.forEach(item => {
                item.addEventListener('click', () => {
                    macroItems.forEach(i => i.classList.remove('bg-primary/10', 'font-medium'));
                    item.classList.add('bg-primary/10', 'font-medium');
                    selectedMacroId = parseInt(item.dataset.macro);
                    loadMacro(selectedMacroId);
                });
            });
            
            // 默认选中第一个宏
            macroItems[0].classList.add('bg-primary/10', 'font-medium');
            
            // 连接设备按钮
            connectBtn.addEventListener('click', async () => {
                if (!device) {
                    try {
                        // 请求用户选择HID设备
                        const devices = await navigator.hid.requestDevice({
                            filters: [{
                                usagePage: HID_MOUSE_USAGE_PAGE,
                                usage: HID_MOUSE_USAGE
                            }]
                        });
                        
                        if (devices.length > 0) {
                            device = devices[0];
                            await device.open();
                            updateDeviceStatus(true);
                            displayDeviceInfo(device);
                            
                            // 监听设备数据
                            device.addEventListener('inputreport', handleInputReport);
                        }
                    } catch (error) {
                        showMessage(`连接设备失败: ${error.message}`, 'error');
                        console.error('HID连接错误:', error);
                    }
                } else {
                    // 断开连接
                    await device.close();
                    device = null;
                    updateDeviceStatus(false);
                }
            });
            
            // 处理从设备接收的数据
            function handleInputReport(event) {
                const { data, device, reportId } = event;
                // 这里可以处理设备发送的报告数据
                console.log(`从设备 ${device.productName} 接收报告 #${reportId}:`, data);
            }
            
            // 更新设备状态显示
            function updateDeviceStatus(connected) {
                const indicator = deviceStatus.querySelector('.status-indicator');
                const text = deviceStatus.querySelector('span:last-child');
                
                if (connected) {
                    indicator.className = 'status-indicator bg-secondary mr-2';
                    text.textContent = '已连接设备';
                    connectBtn.innerHTML = '<i class="fa fa-unplug mr-2"></i>断开连接';
                    deviceInfo.classList.remove('hidden');
                    configurationPanel.classList.remove('hidden');
                } else {
                    indicator.className = 'status-indicator bg-gray-300 mr-2';
                    text.textContent = '未连接设备';
                    connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i>连接鼠标设备';
                    deviceInfo.classList.add('hidden');
                    configurationPanel.classList.add('hidden');
                }
            }
            
            // 显示设备信息
            function displayDeviceInfo(device) {
                manufacturerEl.textContent = device.manufacturerName || '未知';
                productEl.textContent = device.productName || '未知';
                productIdEl.textContent = device.productId.toString(16).padStart(4, '0').toUpperCase();
                vendorIdEl.textContent = device.vendorId.toString(16).padStart(4, '0').toUpperCase();
            }
            
            // 显示消息
            function showMessage(text, type = 'info') {
                messageArea.textContent = text;
                messageArea.classList.remove('hidden', 'bg-green-50', 'text-green-800', 'border', 'border-green-200',
                                           'bg-red-50', 'text-red-800', 'border', 'border-red-200',
                                           'bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
                
                if (type === 'success') {
                    messageArea.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
                } else if (type === 'error') {
                    messageArea.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
                } else {
                    messageArea.classList.add('bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
                }
                
                // 3秒后自动隐藏消息
                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 3000);
            }
            
            // 发送参数到设备的通用函数
            async function sendParameterToDevice(reportId, parameters) {
                if (!device) {
                    showMessage('请先连接设备', 'error');
                    return false;
                }
                
                try {
                    // 创建报告数据缓冲区
                    const data = new Uint8Array(parameters);
                    await device.sendReport(reportId, data);
                    return true;
                } catch (error) {
                    showMessage(`发送数据失败: ${error.message}`, 'error');
                    console.error('发送HID报告错误:', error);
                    return false;
                }
            }
            
            // 设置CPI按钮
            document.getElementById('set-cpi').addEventListener('click', async () => {
                const cpi = parseInt(cpiSlider.value);
                
                // 注意：不同厂商的鼠标使用不同的报告格式和ID
                const success = await sendParameterToDevice(
                    0x01,  // 假设的CPI设置报告ID
                    [0x02, (cpi >> 8) & 0xFF, cpi & 0xFF]  // 参数格式：命令码 + CPI高位 + CPI低位
                );
                
                if (success) {
                    showMessage(`已成功设置CPI为 ${cpi}`, 'success');
                }
            });
            
            // 设置按键按钮
            document.getElementById('set-buttons').addEventListener('click', async () => {
                const swap = swapButtons.checked ? 1 : 0;
                const invert = invertScroll.checked ? 1 : 0;
                
                // 发送按键设置
                const success = await sendParameterToDevice(
                    0x02,  // 假设的按键设置报告ID
                    [0x03, swap, invert]  // 参数格式：命令码 + 互换标志 + 反转滚轮标志
                );
                
                if (success) {
                    showMessage('按键设置已成功应用', 'success');
                }
            });
            
            // 设置双击速度按钮
            document.getElementById('set-double-click').addEventListener('click', async () => {
                const speed = parseInt(doubleClickSpeed.value);
                
                // 发送双击速度设置
                const success = await sendParameterToDevice(
                    0x03,  // 假设的双击速度报告ID
                    [0x04, (speed >> 8) & 0xFF, speed & 0xFF]  // 参数格式：命令码 + 速度高位 + 速度低位
                );
                
                if (success) {
                    showMessage(`已成功设置双击速度为 ${speed}ms`, 'success');
                }
            });
            
            // 设置滚轮速度按钮
            document.getElementById('set-scroll').addEventListener('click', async () => {
                const speed = parseInt(scrollSpeed.value);
                
                // 发送滚轮速度设置
                const success = await sendParameterToDevice(
                    0x04,  // 假设的滚轮速度报告ID
                    [0x05, speed]  // 参数格式：命令码 + 速度值
                );
                
                if (success) {
                    showMessage(`已成功设置滚轮速度为 ${speed}`, 'success');
                }
            });
            
            // 设置回报率按钮
            document.getElementById('set-rate').addEventListener('click', async () => {
                const rate = parseInt(selectedRate.value);
                
                // 发送回报率设置
                const success = await sendParameterToDevice(
                    0x05,  // 假设的回报率报告ID
                    [0x06, rate & 0xFF]  // 参数格式：命令码 + 回报率值
                );
                
                if (success) {
                    showMessage(`已成功设置回报率为 ${rate}Hz`, 'success');
                }
            });
            
            // 设置传感器按钮
            document.getElementById('set-sensor').addEventListener('click', async () => {
                const angle = angleSnapping.checked ? 1 : 0;
                const accel = acceleration.checked ? 1 : 0;
                
                // 发送传感器设置
                const success = await sendParameterToDevice(
                    0x06,  // 假设的传感器设置报告ID
                    [0x07, angle, accel]  // 参数格式：命令码 + 角度捕捉 + 鼠标加速
                );
                
                if (success) {
                    showMessage('传感器设置已成功应用', 'success');
                }
            });
            
            // 设置灯光按钮
            document.getElementById('set-light').addEventListener('click', async () => {
                const mode = lightMode.value;
                const brightness = parseInt(lightBrightness.value);
                
                // 转换灯光模式为数值代码
                let modeCode = 0;
                switch(mode) {
                    case 'static': modeCode = 1; break;
                    case 'breathing': modeCode = 2; break;
                    case 'rainbow': modeCode = 3; break;
                    case 'reactive': modeCode = 4; break;
                    default: modeCode = 0;
                }
                
                // 发送灯光设置
                const success = await sendParameterToDevice(
                    0x07,  // 假设的灯光设置报告ID
                    [0x08, modeCode, brightness]  // 参数格式：命令码 + 模式 + 亮度
                );
                
                if (success) {
                    showMessage('灯光设置已成功应用', 'success');
                }
            });
            
            // 宏录制功能
            startRecordBtn.addEventListener('click', () => {
                isRecording = true;
                currentMacro = [];
                startRecordBtn.classList.add('hidden');
                stopRecordBtn.classList.remove('hidden');
                recordingIndicator.classList.remove('hidden');
                macroSteps.innerHTML = '';
                
                // 记录开始时间
                const recordStartTime = Date.now();
                
                // 监听鼠标事件
                document.addEventListener('mousedown', recordMouseDown);
                document.addEventListener('mouseup', recordMouseUp);
                document.addEventListener('keydown', recordKeyDown);
                document.addEventListener('keyup', recordKeyUp);
                
                function recordMouseDown(e) {
                    if (!isRecording) return;
                    const time = Date.now() - recordStartTime;
                    const action = {
                        type: 'mousedown',
                        button: e.button,
                        time: time
                    };
                    currentMacro.push(action);
                    addMacroStep(action);
                }
                
                function recordMouseUp(e) {
                    if (!isRecording) return;
                    const time = Date.now() - recordStartTime;
                    const action = {
                        type: 'mouseup',
                        button: e.button,
                        time: time
                    };
                    currentMacro.push(action);
                    addMacroStep(action);
                }
                
                function recordKeyDown(e) {
                    if (!isRecording) return;
                    const time = Date.now() - recordStartTime;
                    const action = {
                        type: 'keydown',
                        key: e.key,
                        code: e.code,
                        time: time
                    };
                    currentMacro.push(action);
                    addMacroStep(action);
                }
                
                function recordKeyUp(e) {
                    if (!isRecording) return;
                    const time = Date.now() - recordStartTime;
                    const action = {
                        type: 'keyup',
                        key: e.key,
                        code: e.code,
                        time: time
                    };
                    currentMacro.push(action);
                    addMacroStep(action);
                }
            });
            
            stopRecordBtn.addEventListener('click', () => {
                isRecording = false;
                startRecordBtn.classList.remove('hidden');
                stopRecordBtn.classList.add('hidden');
                recordingIndicator.classList.add('hidden');
                
                // 移除事件监听器
                document.removeEventListener('mousedown', recordMouseDown);
                document.removeEventListener('mouseup', recordMouseUp);
                document.removeEventListener('keydown', recordKeyDown);
                document.removeEventListener('keyup', recordKeyUp);
                
                // 为了避免重复定义的错误，这里需要空函数占位
                function recordMouseDown() {}
                function recordMouseUp() {}
                function recordKeyDown() {}
                function recordKeyUp() {}
            });
            
            // 添加宏步骤到显示
            function addMacroStep(action) {
                const stepEl = document.createElement('div');
                stepEl.className = 'macro-step';
                
                let actionText = '';
                switch(action.type) {
                    case 'mousedown':
                        actionText = `<i class="fa fa-mouse-pointer mr-2"></i>鼠标按下 (按键 ${action.button})`;
                        break;
                    case 'mouseup':
                        actionText = `<i class="fa fa-mouse-pointer mr-2"></i>鼠标释放 (按键 ${action.button})`;
                        break;
                    case 'keydown':
                        actionText = `<i class="fa fa-keyboard-o mr-2"></i>按键按下: ${action.key}`;
                        break;
                    case 'keyup':
                        actionText = `<i class="fa fa-keyboard-o mr-2"></i>按键释放: ${action.key}`;
                        break;
                }
                
                stepEl.innerHTML = `
                    <div class="text-xs text-gray-500 mb-1">${action.time}ms</div>
                    <div>${actionText}</div>
                `;
                
                macroSteps.appendChild(stepEl);
                macroSteps.scrollTop = macroSteps.scrollHeight;
            }
            
            // 保存宏
            saveMacroBtn.addEventListener('click', async () => {
                if (currentMacro.length === 0) {
                    showMessage('请先录制宏操作', 'error');
                    return;
                }
                
                // 这里简化处理，实际应用中需要根据设备规格发送宏数据
                // 宏数据通常需要特殊的编码和分页发送
                
                // 仅发送宏的元数据作为示例
                const success = await sendParameterToDevice(
                    0x08,  // 假设的宏设置报告ID
                    [0x09, selectedMacroId, currentMacro.length]  // 参数格式：命令码 + 宏ID + 步骤数
                );
                
                if (success) {
                    // 保存到本地存储
                    localStorage.setItem(`macro_${selectedMacroId}`, JSON.stringify(currentMacro));
                    showMessage(`宏 ${selectedMacroId} 已成功保存`, 'success');
                }
            });
            
            // 加载宏
            function loadMacro(macroId) {
                const macroData = localStorage.getItem(`macro_${macroId}`);
                if (macroData) {
                    currentMacro = JSON.parse(macroData);
                    renderMacroSteps();
                } else {
                    currentMacro = [];
                    macroSteps.innerHTML = `
                        <div class="text-gray-500 text-center py-10">
                            宏命令将显示在这里<br>点击"开始录制"创建宏
                        </div>
                    `;
                }
            }
            
            // 渲染宏步骤
            function renderMacroSteps() {
                macroSteps.innerHTML = '';
                currentMacro.forEach(step => {
                    addMacroStep(step);
                });
            }
            
            // 新建宏
            newMacroBtn.addEventListener('click', () => {
                currentMacro = [];
                macroSteps.innerHTML = `
                    <div class="text-gray-500 text-center py-10">
                        宏命令将显示在这里<br>点击"开始录制"创建宏
                    </div>
                `;
                showMessage('已创建新宏，请开始录制', 'info');
            });
            
            // 删除宏
            deleteMacroBtn.addEventListener('click', () => {
                if (confirm(`确定要删除宏 ${selectedMacroId} 吗？`)) {
                    localStorage.removeItem(`macro_${selectedMacroId}`);
                    currentMacro = [];
                    macroSteps.innerHTML = `
                        <div class="text-gray-500 text-center py-10">
                            宏命令将显示在这里<br>点击"开始录制"创建宏
                        </div>
                    `;
                    showMessage(`宏 ${selectedMacroId} 已删除`, 'info');
                }
            });
            
            // 绑定宏到按键
            bindMacroBtn.addEventListener('click', async () => {
                const button = macroButton.value;
                if (button === 'none') {
                    showMessage('请选择要绑定的按键', 'error');
                    return;
                }
                
                // 将按钮转换为代码
                let buttonCode = 0;
                switch(button) {
                    case 'button4': buttonCode = 4; break;
                    case 'button5': buttonCode = 5; break;
                    case 'doubleclick': buttonCode = 6; break;
                    case 'scrollup': buttonCode = 7; break;
                    case 'scrolldown': buttonCode = 8; break;
                }
                
                // 发送宏绑定设置
                const success = await sendParameterToDevice(
                    0x09,  // 假设的宏绑定报告ID
                    [0x0A, buttonCode, selectedMacroId]  // 参数格式：命令码 + 按钮代码 + 宏ID
                );
                
                if (success) {
                    showMessage(`宏 ${selectedMacroId} 已成功绑定到 ${macroButton.options[macroButton.selectedIndex].text}`, 'success');
                }
            });
            
            // 播放宏
            playMacroBtn.addEventListener('click', () => {
                if (currentMacro.length === 0) {
                    showMessage('没有可播放的宏', 'error');
                    return;
                }
                
                showMessage('正在播放宏...', 'info');
                
                let lastTime = 0;
                currentMacro.forEach(step => {
                    const delay = step.time - lastTime;
                    lastTime = step.time;
                    
                    setTimeout(() => {
                        // 这里只是模拟宏播放，实际应用中需要发送到设备执行
                        console.log(`执行宏步骤:`, step);
                    }, delay);
                });
            });
            
            // 检查已连接的设备
            navigator.hid.getDevices().then(devices => {
                if (devices.length > 0 && devices[0].productId) {
                    // 如果有已授权的设备，自动连接
                    device = devices[0];
                    device.open().then(() => {
                        updateDeviceStatus(true);
                        displayDeviceInfo(device);
                        device.addEventListener('inputreport', handleInputReport);
                    });
                }
            });
        }
    </script>
</body>
</html>